@inherits LayoutComponentBase
@inject NavigationManager navigationManager
@using FeelFlowAnalysis.Models.ViewModels

@using System.Security.Claims
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="page">
  <div class="sidebar">
    <NavMenu />
  </div>

  <main>
    <div class="top-row">
      <a class="navbar-brand" href="">FeelFlow Analysis</a>
      @if (HttpContext!.User.Identity!.IsAuthenticated)
      {
        <button class="btn btn-primary" @onclick="LogOut">LogOut</button>
        @userEmail      
      }
      else
      {
        <div class="button-pos">
          <NavLink href="Login"><span class="btn btn-primary">LogIn</span></NavLink>
          <NavLink href="Signup"><span class="btn btn-primary">SignUp</span></NavLink>
        </div>
      }
    </div>

    <article class="content px-4">@Body</article>
  </main>
</div>

<div id="blazor-error-ui">
  An unhandled error has occurred.
  <a href="" class="reload">Reload</a>
  <a class="dismiss">🗙</a>
</div>

@code {
    [CascadingParameter]
    private HttpContext? HttpContext { get; set; }

    private async Task LogOut()
    {
      await HttpContext!.SignOutAsync();
      navigationManager.NavigateTo("/logout", true);
    }
    private string? userEmail;
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
          userEmail = user.FindFirst(c => c.Type == ClaimTypes.Email)?.Value ?? "";
    }
}